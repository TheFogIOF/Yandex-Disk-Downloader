<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Скачивание</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f0f2f5;
            text-align: center;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 50px auto;
        }
        #status {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
    </style>
    <script>
        async function init() {
            try {
                const params = new URLSearchParams(location.search);
                const yandexLink = params.get('download');
                
                if (!yandexLink) {
                    showStatus('Ошибка: нет ссылки', 'error');
                    return;
                }
                
                showStatus('Получаю ссылку от Яндекс.Диска...', 'loading');
                
                // Получаем прямую ссылку
                const encoded = encodeURIComponent(yandexLink);
                const response = await fetch(
                    `https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key=${encoded}`
                );
                
                if (!response.ok) throw new Error(`API: ${response.status}`);
                
                const data = await response.json();
                
                if (!data.href) throw new Error('Нет ссылки в ответе');
                
                showStatus('✓ Ссылка получена! Начинаю скачивание...', 'success');
                
                // ВАЖНО: Создаем форму для отправки POST запроса
                // Это обходит ограничения Яндекс.Диска
                startDownload(data.href);
                
            } catch (error) {
                showStatus(`Ошибка: ${error.message}`, 'error');
            }
        }
        
        function startDownload(directUrl) {
            // Создаем скрытую ссылку с атрибутом download
            const link = document.createElement('a');
            link.href = directUrl;
            link.download = ''; // Пустое имя - браузер сам определит
            
            // Добавляем атрибуты для скачивания
            link.setAttribute('type', 'hidden');
            link.style.display = 'none';
            
            // Добавляем на страницу и кликаем
            document.body.appendChild(link);
            link.click();
            
            // Удаляем ссылку
            setTimeout(() => {
                document.body.removeChild(link);
                showStatus('✓ Скачивание началось!', 'success');
                
                // Закрываем окно через 2 секунды
                setTimeout(() => {
                    closeWindow();
                }, 2000);
            }, 100);
        }
        
        function showStatus(text, type) {
            const el = document.getElementById('status');
            el.innerHTML = text;
            
            if (type === 'error') {
                el.style.color = '#dc3545';
                el.style.borderLeft = '4px solid #dc3545';
            } else if (type === 'success') {
                el.style.color = '#28a745';
                el.style.borderLeft = '4px solid #28a745';
            } else {
                el.style.color = '#007bff';
                el.style.borderLeft = '4px solid #007bff';
            }
        }
        
        function closeWindow() {
            try {
                // Пытаемся закрыть окно
                if (window.opener && !window.opener.closed) {
                    window.close();
                } else {
                    // Если нельзя закрыть, показываем кнопку
                    document.getElementById('closeBtn').style.display = 'inline-block';
                }
            } catch(e) {
                document.getElementById('closeBtn').style.display = 'inline-block';
            }
        }
        
        // Запускаем при загрузке
        window.addEventListener('DOMContentLoaded', init);
    </script>
</head>
<body>
    <div class="container">
        <h3>Скачивание с Яндекс.Диска</h3>
        <div id="status">Загрузка...</div>
        <div>
            <a href="#" class="btn" onclick="closeWindow()" id="closeBtn" style="display:none;">
                Закрыть окно
            </a>
            <a href="#" class="btn" onclick="location.reload()" style="background:#6c757d;">
                Повторить
            </a>
        </div>
    </div>
</body>
</html>
